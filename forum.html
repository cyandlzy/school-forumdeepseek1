<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园论坛</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .forum-header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .forum-header h1 {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            transition: background-color 0.3s;
        }

        .user-info button:hover {
            background-color: #2980b9;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 120px);
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }

        .sidebar {
            width: 100%;
            padding: 1rem;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) {
            .sidebar {
                width: 250px;
                margin-right: 1rem;
                margin-bottom: 0;
            }
        }

        .content {
            flex: 1;
            background-color: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .categories h3, .stats h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .categories ul {
            list-style: none;
        }

        .categories li {
            padding: 0.5rem 0;
            cursor: pointer;
            transition: color 0.3s;
        }

        .categories li:hover, .categories li.active {
            color: #3498db;
            font-weight: bold;
        }

        .stats p {
            margin: 0.5rem 0;
            color: #666;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .toolbar {
                flex-direction: row;
            }
        }

        #new-topic-btn {
            padding: 0.5rem 1rem;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #new-topic-btn:hover {
            background-color: #27ae60;
        }

        .search-box {
            display: flex;
            width: 100%;
        }

        @media (min-width: 768px) {
            .search-box {
                width: auto;
            }
        }

        .search-box input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            flex: 1;
        }

        .search-box button {
            padding: 0.5rem 1rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        .topics-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .topic-item {
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 5px;
            transition: box-shadow 0.3s;
            cursor: pointer;
        }

        .topic-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .topic-title {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .topic-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: #eee;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .topic-content {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .replies {
            margin-top: 2rem;
        }

        .reply-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .forum-footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            color: #e74c3c;
            padding: 1rem;
            background-color: #fdeded;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header class="forum-header">
        <h1>校园交流论坛</h1>
        <div class="user-info">
            <span id="username">游客</span>
            <button id="login-btn">登录</button>
            <button id="register-btn">注册</button>
            <button id="logout-btn" style="display:none">退出</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="categories">
                <h3>分类</h3>
                <ul>
                    <li class="active" data-category="all">全部主题</li>
                    <li data-category="学习交流">学习交流</li>
                    <li data-category="校园生活">校园生活</li>
                    <li data-category="社团活动">社团活动</li>
                    <li data-category="问题求助">问题求助</li>
                </ul>
            </div>
            <div class="stats">
                <h3>论坛统计</h3>
                <p>主题: <span id="topic-count">0</span></p>
                <p>回复: <span id="reply-count">0</span></p>
                <p>用户: <span id="user-count">0</span></p>
            </div>
        </aside>

        <main class="content">
            <div class="toolbar">
                <button id="new-topic-btn">发表新主题</button>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="搜索主题...">
                    <button id="search-btn">搜索</button>
                </div>
            </div>

            <div class="topics-list">
                <div class="loading">加载中...</div>
            </div>
        </main>
    </div>

    <!-- 发表新主题模态框 -->
    <div class="modal" id="new-topic-modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h2>发表新主题</h2>
            <form id="new-topic-form">
                <div class="form-group">
                    <label for="topic-title">标题</label>
                    <input type="text" id="topic-title" required>
                </div>
                <div class="form-group">
                    <label for="topic-category">分类</label>
                    <select id="topic-category">
                        <option value="学习交流">学习交流</option>
                        <option value="校园生活">校园生活</option>
                        <option value="社团活动">社团活动</option>
                        <option value="问题求助">问题求助</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="topic-content">内容</label>
                    <textarea id="topic-content" rows="8" required></textarea>
                </div>
                <button type="submit">发表</button>
            </form>
        </div>
    </div>

    <!-- 登录/注册模态框 -->
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <div class="auth-tabs">
                <button class="tab-btn active" data-tab="login">登录</button>
                <button class="tab-btn" data-tab="register">注册</button>
            </div>
            
            <div id="auth-error" class="error" style="display:none"></div>
            
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">邮箱</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">登录</button>
            </form>
            
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-email">邮箱</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-group">
                    <label for="register-confirm">确认密码</label>
                    <input type="password" id="register-confirm" required>
                </div>
                <button type="submit">注册</button>
            </form>
        </div>
    </div>

    <!-- 主题详情页 -->
    <div class="modal" id="topic-detail-modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h2 id="detail-title"></h2>
            <div class="topic-meta">
                <span id="detail-author"></span>
                <span id="detail-category"></span>
                <span id="detail-date"></span>
            </div>
            <div class="topic-content" id="detail-content"></div>
            
            <div class="replies">
                <h3>回复</h3>
                <div class="replies-list" id="replies-list">
                    <div class="loading">加载中...</div>
                </div>
                
                <form id="new-reply-form">
                    <textarea id="reply-content" placeholder="发表你的回复..." required></textarea>
                    <button type="submit">回复</button>
                </form>
            </div>
        </div>
    </div>

    <footer class="forum-footer">
        <p>© 2025 校园论坛</p>
    </footer>

    <script>
        // ====================
        // Supabase 初始化
        // ====================
        // 请替换为您的Supabase项目URL和anon key
        const supabaseUrl = 'https://tkvmklukmbmnmcvnzvst.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrdm1rbHVrbWJtbm1jdm56dnN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMzQwNzksImV4cCI6MjA3MjgxMDA3OX0.I3dLKYQi4ExujKtE0bQIubJCVrpOeZbvIox1cP_6rpM';
        
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // ====================
        // DOM元素
        // ====================
        const topicsList = document.querySelector('.topics-list');
        const topicCount = document.getElementById('topic-count');
        const replyCount = document.getElementById('reply-count');
        const userCount = document.getElementById('user-count');
        const usernameSpan = document.getElementById('username');
        
        // 模态框元素
        const newTopicModal = document.getElementById('new-topic-modal');
        const authModal = document.getElementById('auth-modal');
        const topicDetailModal = document.getElementById('topic-detail-modal');
        const authError = document.getElementById('auth-error');
        
        // 按钮元素
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const newTopicBtn = document.getElementById('new-topic-btn');
        const searchBtn = document.getElementById('search-btn');
        
        // 表单元素
        const newTopicForm = document.getElementById('new-topic-form');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const newReplyForm = document.getElementById('new-reply-form');
        const searchInput = document.getElementById('search-input');
        
        // 分类元素
        const categoryItems = document.querySelectorAll('.categories li');
        
        // 全局变量
        let currentUser = null;
        let currentTopicId = null;
        let currentCategory = 'all';
        let currentSearch = '';
        
        // ====================
        // 初始化函数
        // ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查用户登录状态
            await checkAuthState();
            
            // 加载论坛数据
            await loadForumStats();
            await loadTopics();
            
            // 设置事件监听器
            setupEventListeners();
        });
        
        // ====================
        // 功能函数
        // ====================
        async function checkAuthState() {
            const { data, error } = await supabase.auth.getSession();
            
            if (data.session) {
                currentUser = data.session.user;
                usernameSpan.textContent = currentUser.email;
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            } else {
                currentUser = null;
                usernameSpan.textContent = '游客';
                loginBtn.style.display = 'block';
                registerBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
        }
        
        async function loadForumStats() {
            try {
                // 获取主题数量
                const { count: topicCountData } = await supabase
                    .from('topics')
                    .select('*', { count: 'exact', head: true });
                
                // 获取回复数量
                const { count: replyCountData } = await supabase
                    .from('replies')
                    .select('*', { count: 'exact', head: true });
                
                // 获取用户数量
                const { count: userCountData } = await supabase
                    .from('profiles')
                    .select('*', { count: 'exact', head: true });
                
                topicCount.textContent = topicCountData || 0;
                replyCount.textContent = replyCountData || 0;
                userCount.textContent = userCountData || 0;
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }
        
        async function loadTopics() {
            topicsList.innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                let query = supabase
                    .from('topics')
                    .select(`
                        id,
                        title,
                        content,
                        category,
                        created_at,
                        profiles:user_id (username)
                    `)
                    .order('created_at', { ascending: false });
                
                if (currentCategory !== 'all') {
                    query = query.eq('category', currentCategory);
                }
                
                if (currentSearch) {
                    query = query.ilike('title', `%${currentSearch}%`);
                }
                
                const { data: topics, error } = await query;
                
                if (error) throw error;
                
                if (topics.length === 0) {
                    topicsList.innerHTML = '<div class="no-topics">暂无主题</div>';
                    return;
                }
                
                topicsList.innerHTML = '';
                
                topics.forEach(topic => {
                    const topicItem = document.createElement('div');
                    topicItem.className = 'topic-item';
                    topicItem.dataset.id = topic.id;
                    
                    const date = new Date(topic.created_at).toLocaleString();
                    
                    topicItem.innerHTML = `
                        <div class="topic-title">${topic.title}</div>
                        <div class="topic-meta">
                            <span>作者: ${topic.profiles.username}</span>
                            <span>分类: ${topic.category}</span>
                            <span>时间: ${date}</span>
                        </div>
                    `;
                    
                    topicItem.addEventListener('click', () => {
                        showTopicDetail(topic.id);
                    });
                    
                    topicsList.appendChild(topicItem);
                });
            } catch (error) {
                console.error('加载主题失败:', error);
                topicsList.innerHTML = '<div class="error">加载主题失败，请稍后再试</div>';
            }
        }
        
        async function showTopicDetail(topicId) {
            currentTopicId = topicId;
            
            // 显示加载状态
            document.getElementById('replies-list').innerHTML = '<div class="loading">加载中...</div>';
            
            try {
                // 获取主题详情
                const { data: topic, error: topicError } = await supabase
                    .from('topics')
                    .select(`
                        id,
                        title,
                        content,
                        category,
                        created_at,
                        profiles:user_id (username)
                    `)
                    .eq('id', topicId)
                    .single();
                
                if (topicError) throw topicError;
                
                // 获取回复
                const { data: replies, error: repliesError } = await supabase
                    .from('replies')
                    .select(`
                        id,
                        content,
                        created_at,
                        profiles:user_id (username)
                    `)
                    .eq('topic_id', topicId)
                    .order('created_at', { ascending: true });
                
                if (repliesError) throw repliesError;
                
                // 更新UI
                document.getElementById('detail-title').textContent = topic.title;
                document.getElementById('detail-author').textContent = `作者: ${topic.profiles.username}`;
                document.getElementById('detail-category').textContent = `分类: ${topic.category}`;
                document.getElementById('detail-date').textContent = `时间: ${new Date(topic.created_at).toLocaleString()}`;
                document.getElementById('detail-content').textContent = topic.content;
                
                // 渲染回复列表
                const repliesList = document.getElementById('replies-list');
                repliesList.innerHTML = '';
                
                if (replies && replies.length > 0) {
                    replies.forEach(reply => {
                        const replyItem = document.createElement('div');
                        replyItem.className = 'reply-item';
                        replyItem.innerHTML = `
                            <div class="reply-meta">
                                <strong>${reply.profiles.username}</strong> 于 ${new Date(reply.created_at).toLocaleString()} 回复:
                            </div>
                            <div class="reply-content">${reply.content}</div>
                        `;
                        repliesList.appendChild(replyItem);
                    });
                } else {
                    repliesList.innerHTML = '<div class="no-replies">暂无回复</div>';
                }
                
                showModal(topicDetailModal);
            } catch (error) {
                console.error('加载主题详情失败:', error);
                document.getElementById('replies-list').innerHTML = '<div class="error">加载失败，请稍后再试</div>';
            }
        }
        
        function showModal(modal) {
            hideAllModals();
            modal.style.display = 'flex';
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        // ====================
        // 事件处理
        // ====================
        function setupEventListeners() {
            // 登录按钮
            loginBtn.addEventListener('click', () => {
                authError.style.display = 'none';
                showModal(authModal);
            });
            
            // 注册按钮
            registerBtn.addEventListener('click', () => {
                authError.style.display = 'none';
                showModal(authModal);
            });
            
            // 退出按钮
            logoutBtn.addEventListener('click', async () => {
                const { error } = await supabase.auth.signOut();
                if (!error) {
                    currentUser = null;
                    usernameSpan.textContent = '游客';
                    loginBtn.style.display = 'block';
                    registerBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                }
            });
            
            // 发表新主题按钮
            newTopicBtn.addEventListener('click', () => {
                if (currentUser) {
                    newTopicForm.reset();
                    showModal(newTopicModal);
                } else {
                    showModal(authModal);
                }
            });
            
            // 关闭模态框
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', hideAllModals);
            });
            
            // 点击模态框背景关闭
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideAllModals();
                    }
                });
            });
            
            // 标签切换
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    
                    // 更新激活的标签
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 更新显示的表单
                    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                    document.getElementById(`${tab}-form`).classList.add('active');
                });
            });
            
            // 分类选择
            categoryItems.forEach(item => {
                item.addEventListener('click', () => {
                    categoryItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentCategory = item.dataset.category;
                    loadTopics();
                });
            });
            
            // 搜索
            searchBtn.addEventListener('click', () => {
                currentSearch = searchInput.value.trim();
                loadTopics();
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearch = searchInput.value.trim();
                    loadTopics();
                }
            });
            
            // 表单提交
            newTopicForm.addEventListener('submit', handleNewTopic);
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            newReplyForm.addEventListener('submit', handleNewReply);
        }
        
        async function handleNewTopic(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('请先登录后再发帖');
                hideAllModals();
                showModal(authModal);
                return;
            }
            
            const title = document.getElementById('topic-title').value;
            const category = document.getElementById('topic-category').value;
            const content = document.getElementById('topic-content').value;
            
            try {
                const { data, error } = await supabase
                    .from('topics')
                    .insert([
                        {
                            title,
                            content,
                            category,
                            user_id: currentUser.id
                        }
                    ]);
                
                if (error) throw error;
                
                // 更新UI
                loadTopics();
                loadForumStats();
                newTopicForm.reset();
                hideAllModals();
                alert('主题发表成功！');
            } catch (error) {
                console.error('发表主题失败:', error);
                alert('发表主题失败，请稍后再试');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                usernameSpan.textContent = currentUser.email;
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                
                hideAllModals();
                loginForm.reset();
            } catch (error) {
                console.error('登录失败:', error);
                authError.textContent = error.message || '登录失败';
                authError.style.display = 'block';
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            
            if (password !== confirm) {
                authError.textContent = '两次输入的密码不一致';
                authError.style.display = 'block';
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });
                
                if (error) throw error;
                
                // 创建用户资料
                await supabase
                    .from('profiles')
                    .insert([
                        {
                            id: data.user.id,
                            username: email.split('@')[0],
                            email
                        }
                    ]);
                
                authError.textContent = '注册成功！请检查您的邮箱验证账户';
                authError.style.color = '#2ecc71';
                authError.style.display = 'block';
                
                // 清空表单
                registerForm.reset();
                
                // 更新用户统计
                loadForumStats();
            } catch (error) {
                console.error('注册失败:', error);
                authError.textContent = error.message || '注册失败';
                authError.style.display = 'block';
            }
        }
        
        async function handleNewReply(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('请先登录后再回复');
                hideAllModals();
                showModal(authModal);
                return;
            }
            
            const content = document.getElementById('reply-content').value;
            
            try {
                const { data, error } = await supabase
                    .from('replies')
                    .insert([
                        {
                            content,
                            topic_id: currentTopicId,
                            user_id: currentUser.id
                        }
                    ]);
                
                if (error) throw error;
                
                // 重新加载回复
                showTopicDetail(currentTopicId);
                
                // 清空表单
                document.getElementById('reply-content').value = '';
                
                // 更新统计
                loadForumStats();
            } catch (error) {
                console.error('发表回复失败:', error);
                alert('发表回复失败，请稍后再试');
            }
        }
    </script>
</body>
</html>
